<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../fs-request/fs-request.html">

<dom-module id="fs-date">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <fs-request id="request" url="{{_computeUrl(original)}}" on-response="_handleResponse"></fs-request>
    <paper-autocomplete 
      id="autocomplete" 
      label="date" 
      no-label-float 
      remote-source
      on-autocomplete-change="_autocompleteChange"
      on-autocomplete-selected="_autocompleteSelected"></paper-autocomplete>
  </template>

  <script>
    /**
     * `fs-date`
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class FsDate extends Polymer.Element {
      
      static get is() { return 'fs-date'; }
      
      static get properties() {
        return {
          date: {
            type: Object,
            notify: true
          }
        };
      }
      
      ready() {
        super.ready();
        this.$.request.headers = {
          Accept: 'text/plain'
        };
      }
      
      _computeUrl() {
        if(this.original) {
          return `/platform/dates?date=${this.original}`;
        }
      }
      
      _autocompleteChange(e) {
        if(e.detail && e.detail.text) {
          this.original = e.detail.text;
        }
        // TODO: debounce
        this.$.request.generateRequest();
      }
      
      _autocompleteSelected(e) {
        this.date = JSON.parse(e.detail.value);
      }
      
      _handleResponse(e) {
        const response = e.detail.response;
        if(response.statusCode === 200) {
          const value = {
            original: response.body,
            normalized: [{
              lang: response.headers['content-language'],
              value: response.body
            }],
            formal: response.headers.location ? response.headers.location.replace('gedcomx-date:', '') : undefined
          };
          this.$.autocomplete.suggestions([
            {
              text: response.body,
              value: JSON.stringify(value)
            }
          ]);
        }
      }
    }

    window.customElements.define(FsDate.is, FsDate);
  </script>
</dom-module>
